##############################################
# Functions relating to gcc

function prep_gcc_core () {
    cd ${BUILD_DIR}
    if [ -e ${1} ]; then
        echo ${1} already exists
        return 0
    fi
    local v
    v=${1#gcc-core-}
    if [ -e "gcc-$v" ]; then
        echo ${1} not overwriting gcc
        return 1
    fi
    untar gcc-core-$v || untar gcc-$v || return 1
    mv gcc-$v $1
    cd ${1}

    # Debian sources
    case ${1} in
    ( gcc-core-2.95.3 )
        decompress ${PATCHES}/gcc-2.95.4.ds15-27.diff | patch -p1
        ;;
    ( gcc-core-3.3.6 )
        decompress ${PATCHES}/gcc-core-3.3.6ds1-15.diff | patch -p1
        ;;
    ( gcc-core-4.1.1 )
        decompress ${PATCHES}/gcc-core-4.1.1ds2-21.diff | patch -p1
        ;;
    esac

    case ${1} in
    ( gcc-core-2.95.* )
        # Crosstool patches
        patch -p1 < ${PATCHES}/gcc-pr3106.patch
        patch -p1 < ${PATCHES}/backport-config.gcc-1.4.patch
        # More autotools fixes
        patch -p1 < ${PATCHES}/gcc-2.95.2-host-darwin.diff
        ;;
    ( gcc-core-3.[01].* )
        ;;
    ( gcc-core-3.* )
        if [ x${GLIBC_NEEDS_SHARED_GCC} = xyes ]; then
            patch -p0 < ${PATCHES}/gcc-3.2-btc-shlib-sans-libc.patch
        fi
        ;;
    ( gcc-core-4.0.* )
        # We build gcc-core only before libc is built
        patch -p1 < ${PATCHES}/gcc-4-no-libc-yet.diff
        # Bug fix
        patch -p1 < ${PATCHES}/gcc-4.0-pr20583.patch
        ;;
    ( gcc-core-4.1.* )
        # We build gcc-core only before libc is built
        patch -p1 < ${PATCHES}/gcc-4-no-libc-yet.diff
        ;;
    esac
}

function prep_gcc () {
    cd ${BUILD_DIR}
    if [ -e ${1} ]; then
        echo ${1} already exists
        return 0
    fi
    untar ${1}
    cd ${1}

    # Debian sources
    case ${1} in
    ( gcc-2.95.3 )
        decompress ${PATCHES}/gcc-2.95.4.ds15-27.diff | patch -p1
        ;;
    ( gcc-3.3.6 )
        decompress ${PATCHES}/gcc-3.3.6ds1-15.diff | patch -p1
        ;;
    ( gcc-4.1.1 )
        decompress ${PATCHES}/gcc-4.1.1ds2-21.diff | patch -p1
        ;;
    esac

    case ${1} in
    ( gcc-2.95.3 )
        # Crosstool patches
        patch -p1 < ${PATCHES}/gcc-pr3106.patch
        patch -p1 < ${PATCHES}/backport-config.gcc-1.4.patch
        # More autotools fixes
        patch -p1 < ${PATCHES}/gcc-2.95.2-host-darwin.diff
        ;;
    ( gcc-3.3.* )
        patch -p0 < ${PATCHES}/gcc-3.3-no-include-filio.patch
        ;;
    ( gcc-3.4.* )
        patch -p0 < ${PATCHES}/gcc-3.4-btc-no-include-filio.patch
        patch -p1 < ${PATCHES}/gcc-3.4.1-btc-use-target-cpp-for-lib-configure.patch
        ;;
    ( gcc-4.0.* )
        patch -p0 < ${PATCHES}/gcc-3.4-btc-no-include-filio.patch
        # Bug fix
        patch -p1 < ${PATCHES}/gcc-4.0-pr20583.patch
        ;;
    ( gcc-4.1.* )
        patch -p0 < ${PATCHES}/gcc-3.4-btc-no-include-filio.patch
        ;;
    esac
}

function install_gcc_core_static () {
    cd ${BUILD_DIR}
    if [ -e ${1} ]; then
        echo ${1} already exists
        return 0
    fi
    mkdir ${1}
    cd ${1}

    CFLAGS="-O2 $HOST_CFLAGS" \
../${GCC_CORE_DIST}/configure \
--prefix=${TC_PREFIX} --target=${TARGET} \
${GCC_CONFIG_OPTS} \
--with-newlib \
--disable-multilib \
--disable-nls \
--enable-symvers=gnu \
--enable-threads=posix \
--enable-__cxa_atexit \
--enable-languages=c \
--disable-shared \
--disable-libmudflap --disable-libssp --disable-libunwind-exceptions
    make all-gcc
    make install-gcc 

    manifest install_gcc_core_static
}

function install_gcc_core_shared () {
    cd ${BUILD_DIR}
    if [ -e ${1} ]; then
        echo ${1} already exists
        return 0
    fi
    mkdir ${1}
    cd ${1}

    CFLAGS="-O2 $HOST_CFLAGS" \
../${GCC_CORE_DIST}/configure \
--prefix=${TC_PREFIX} --target=${TARGET} \
${GCC_CONFIG_OPTS} \
--with-newlib \
--disable-multilib \
--disable-nls \
--enable-threads=posix \
--enable-symvers=gnu \
--enable-__cxa_atexit \
--enable-languages=c \
--enable-shared
    mkdir -p gcc
    cp ../glibc-${TARGET}-2/csu/crt[in].o gcc
    make all-gcc
    make install-gcc 

    manifest install_gcc_core_shared
}

function install_gcc () {
    cd ${BUILD_DIR}
    if [ -e ${1} ]; then
        echo ${1} already exists
        return 0
    fi
    mkdir ${1}
    cd ${1}

    CFLAGS="-O2 $HOST_CFLAGS" \
../${GCC_DIST}/configure \
--prefix=${TC_PREFIX} --target=${TARGET} \
${GCC_CONFIG_OPTS} \
--enable-threads=posix \
--enable-__cxa_atexit \
--enable-languages=c,c++ \
--enable-shared \
--enable-c99 \
--enable-long-long
#--enable-languages=ada,c,c++,f77,java,objc,pascal
    make all
    make install

    manifest install_gcc
}

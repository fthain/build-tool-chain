##############################################
#
# Functions relating to host-native tools

function install_host_tool () {
    echo unpacking $1
    cd $BTC_BUILD
    untar "$@"

    cd $1
    echo building $1

    CFLAGS="-O2" ./configure --disable-nls --prefix=${HOST_TOOLS_PREFIX} \
                             --infodir=${HOST_TOOLS_PREFIX}/share/info \
                             --mandir=${HOST_TOOLS_PREFIX}/share/man
    make ${MAKE_OPTS}

    echo installing $1

    rm -rf ${BTC_BUILD}/image
    make DESTDIR=${BTC_BUILD}/image install
}

function merge_host_tool () {
    pushd ${BTC_BUILD}/image/${HOST_TOOLS_PREFIX} >/dev/null

    test -d share/man && ln -nsf share/man ${BTC_BUILD}/image/man

    rm -f share/info/dir

    if test -d lib ; then
        find lib -type f \( -name '*.la' -o -name '*.a' \) -print0 | xargs -0 rm -fv
        rmdir lib || true
    fi

    tar -c "$@" | tar -C ${HOST_TOOLS_PREFIX} -xpv

    popd >/dev/null
    rm -rf ${BTC_BUILD}/image
}

function install_sed () {
    test -e ${HOST_TOOLS_PREFIX}/bin/${1%%-*} && return

    install_host_tool $1 ftp://ftp.gnu.org/gnu/sed
    ln -nsf sed ${BTC_BUILD}/image/${HOST_TOOLS_PREFIX}/bin/gsed
    merge_host_tool bin share/{info,man}
}

function install_make () {
    test -e ${HOST_TOOLS_PREFIX}/bin/${1%%-*} && return

    install_host_tool $1 ftp://ftp.gnu.org/gnu/make
    ln -nsf make ${BTC_BUILD}/image/${HOST_TOOLS_PREFIX}/bin/gnumake
    merge_host_tool bin share/{info,man}
}

function install_gettext () {
    test -e ${HOST_TOOLS_PREFIX}/bin/${1%%-*} && return

    install_host_tool $1 ftp://ftp.gnu.org/gnu/gettext
    merge_host_tool bin lib include share/{info,man}
}

function install_coreutils () {
    test -e ${HOST_TOOLS_PREFIX}/bin/readlink && return

    echo unpacking $1
    cd $BTC_BUILD
    untar $1 ftp://ftp.gnu.org/gnu/coreutils

    cd $1
    echo building $1

    CFLAGS="-O2" ./configure --disable-nls --prefix=${HOST_TOOLS_PREFIX}
    make ${MAKE_OPTS}

    echo installing $1

    rm -rf ${BTC_BUILD}/image
    make DESTDIR=${BTC_BUILD}/image install

    merge_host_tool bin/{readlink,expr,install}
}

function install_loadkeys () {
    test -e ${HOST_TOOLS_PREFIX}/bin/loadkeys && return
    
    echo unpacking $1
    cd $BTC_BUILD
    untar $1 ftp://ftp.kernel.org/pub/linux/utils/kbd

    cd $1
    patch -p1 < ${BTC_PATCHES}/kbd-1.12-gentoo.diff
    patch -p1 < ${BTC_PATCHES}/kbd-1.12-btc-darwin.diff

    echo building $1

    CFLAGS="-O2" ./configure --disable-nls --prefix=${HOST_TOOLS_PREFIX}
    cd src
    make analyze.c loadkeys

    cp -p loadkeys ${HOST_TOOLS_PREFIX}/bin
}

function install_find_pl () {
    local pn
    pn=find.pl
    test -e ${HOST_TOOLS_PREFIX}/bin/${pn} && return

    echo installing $pn

    if ! test -f ${BTC_SOURCES}/${pn}.bz2 ; then
        fetch_stdout http://www.telegraphics.com.au/~fthain/sw/${pn} \
            | bzip2 -c > ${BTC_SOURCES}/${pn}.bz2
    fi
    cd ${HOST_TOOLS_PREFIX}/bin
    decompress ${BTC_SOURCES}/${pn} > ${pn}
    chmod 755 ${pn}
}

function install_gawk () {
    test -e ${HOST_TOOLS_PREFIX}/bin/${1%%-*} && return

    install_host_tool $1 ftp://ftp.gnu.org/gnu/gawk
    ln -nsf gawk ${BTC_BUILD}/image/${HOST_TOOLS_PREFIX}/bin/awk
    merge_host_tool bin/{gawk,awk} share/info/gawk.info share/man/man1/gawk.1
}

function install_bison () {
    test -e ${HOST_TOOLS_PREFIX}/bin/${1%%-*} && return

    install_host_tool $1 ftp://ftp.gnu.org/gnu/bison
    merge_host_tool bin share
}

function install_flex () {
    test -e ${HOST_TOOLS_PREFIX}/bin/${1%%-*} && return

    echo unpacking $1
    cd $BTC_BUILD
    untar $1 http://prdownloads.sourceforge.net/flex
    cd ${1%a}
    patch -p1 < ${BTC_PATCHES}/flex-2.5.4a-r6.diff

    echo building $1

    CFLAGS="-O2" ./configure --disable-nls --prefix=${HOST_TOOLS_PREFIX}
    make ${MAKE_OPTS}

    echo installing $1

    rm -rf ${BTC_BUILD}/image
    make DESTDIR=${BTC_BUILD}/image install

    merge_host_tool bin include share/man
}

function install_gmp () {
    test -e ${HOST_TOOLS_PREFIX}/include/gmp.h && return

    echo unpacking $1
    cd $BTC_BUILD
    untar $1 ftp://ftp.gnu.org/gnu/gmp

    cd $1
    echo building $1

    (
        local opts
        if [ ${BUILD} != "${BUILD#powerpc-apple-darwin}" ] ; then
            export CFLAGS="-Wa,-force_cpusubtype_ALL -std=gnu89"
            opts="--with-pic"
        elif [ ${BUILD} != "${BUILD#i386-apple-darwin9}" ] ; then
            export CFLAGS="-std=gnu89"
            opts="--build=none-apple-darwin"
        else
            opts=
        fi
        ./configure --disable-nls --prefix=${HOST_TOOLS_PREFIX} \
                    --infodir=${HOST_TOOLS_PREFIX}/share/info \
                    --enable-cxx --with-gmp=${HOST_TOOLS_PREFIX} \
                    --disable-mpfr --disable-mpbsd $opts
    )
    make ${MAKE_OPTS}

    echo installing $1

    rm -rf ${BTC_BUILD}/image
    make DESTDIR=${BTC_BUILD}/image install

    merge_host_tool include lib share/info
}

function install_mpfr () {
    test -e ${HOST_TOOLS_PREFIX}/include/mpfr.h && return

    echo unpacking $1
    cd $BTC_BUILD
    untar $1 http://www.mpfr.org/$1

    cd $1
    patch -p1 < ${BTC_PATCHES}/mpfr-2.4.2-gentoo.patch

    echo building $1

    local opts
    if [ ${BUILD} != "${BUILD#i386-apple-darwin9}" ] ; then
        opts="--build=none-apple-darwin"
    else
        opts=
    fi

    ./configure --disable-nls --prefix=${HOST_TOOLS_PREFIX} \
                --with-gmp=${HOST_TOOLS_PREFIX} $opts
    make ${MAKE_OPTS}

    echo installing $1

    rm -rf ${BTC_BUILD}/image
    make DESTDIR=${BTC_BUILD}/image install

    merge_host_tool include lib share/info
}

function install_m4 () {
    test -e ${HOST_TOOLS_PREFIX}/bin/${1%%-*} && return

    install_host_tool $1 ftp://ftp.gnu.org/gnu/m4
    merge_host_tool bin share
}

function install_ppl () {
    test -e ${HOST_TOOLS_PREFIX}/include/ppl_c.h && return

    echo unpacking $1
    cd $BTC_BUILD
    untar $1 ftp://ftp.cs.unipr.it/pub/ppl/releases/${1#*-}

    cd $1
    echo building $1

    CFLAGS="-O2" ./configure --disable-nls --prefix=${HOST_TOOLS_PREFIX} \
                             --disable-optimization --enable-interfaces=c,cxx \
                             --with-gmp=${HOST_TOOLS_PREFIX}
    make ${MAKE_OPTS}

    echo installing $1

    rm -rf ${BTC_BUILD}/image
    make DESTDIR=${BTC_BUILD}/image install

    merge_host_tool include lib share/man/man3
}

function install_cloog_ppl () {
    test -e ${HOST_TOOLS_PREFIX}/include/cloog && return

    echo unpacking $1
    cd $BTC_BUILD
    untar $1 ftp://gcc.gnu.org/pub/gcc/infrastructure

    cd $1
    echo building $1

    CFLAGS="-O2" ./configure --disable-nls --prefix=${HOST_TOOLS_PREFIX} \
                             --with-gmp=${HOST_TOOLS_PREFIX} \
                             --with-ppl=${HOST_TOOLS_PREFIX}
    make ${MAKE_OPTS}

    echo installing $1

    rm -rf ${BTC_BUILD}/image
    make DESTDIR=${BTC_BUILD}/image install

    merge_host_tool include lib
}

function install_depmod () {
    test -e ${HOST_TOOLS_PREFIX}/bin/${1%%-*} && return

    echo installing $1

    if ! test -f ${BTC_SOURCES}/${1}.bz2 ; then
        fetch_stdout http://git.busybox.net/busybox/plain/examples/depmod.pl?h=${1#*-} \
            | bzip2 -c > ${BTC_SOURCES}/${1}.bz2
    fi
    cd ${HOST_TOOLS_PREFIX}/bin
    decompress ${BTC_SOURCES}/${1} > depmod.pl
    chmod 755 depmod.pl
}
